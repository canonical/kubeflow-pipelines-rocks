# Dockerfile: https://github.com/kubeflow/pipelines/blob/2.0.0/frontend/Dockerfile
name: frontend
base: ubuntu:22.04
version: '2.0.0_22.04_1'
summary: Kubeflow Pipelines Management Frontend
description: |
    This rock runs a frontend development server.
license: Apache-2.0
platforms:
    amd64:
run-user: _daemon_
services:
  ml-frontend:
    command: node /server/server/dist/server.js /client/ 3000
    override: replace
    startup: enabled
    environment:
      API_SERVER_ADDRESS: http://localhost:3001
parts:
  security-team-requirement:
    plugin: nil
    override-build: |
      mkdir -p ${CRAFT_PART_INSTALL}/usr/share/rocks
      (echo "# os-release" && cat /etc/os-release && echo "# dpkg-query" && dpkg-query -f '${db:Status-Abbrev},${binary:Package},${Version},${source:Package},${Source:Version}\n' -W) > ${CRAFT_PART_INSTALL}/usr/share/rocks/dpkg.query

  # This part builds the client side of the frontend container image
  frontend:
    plugin: npm
    source: https://github.com/kubeflow/pipelines.git
    source-tag: 2.0.0
    build-snaps:
    - node/14/stable
    override-build: |
        # Change working directory to pipelines/frontend
        cd frontend
        npm ci && npm run postinstall
        npm run build
        # Create a client directory in root and copy the build directory into it
        mkdir -p ${CRAFT_PART_INSTALL}/client
        cp -a build ${CRAFT_PART_INSTALL}/client

  # This part builds the server side of the frontend container image
  backend:
    plugin: npm
    source: https://github.com/kubeflow/pipelines.git
    source-tag: 2.0.0
    build-snaps:
    - node/14/stable
    override-build: |
        # Change working directory to pipelines/frontend
        cd ./frontend
        mkdir -p ./server/dist
        export BUILD_VERSION=$(git describe --abbrev=0 --tags)
        export BUILD_COMMIT=$(git rev-parse HEAD)
        export BUILD_DATE=$(date "+%F-%H-%M-%S")
        echo $BUILD_COMMIT > ./server/dist/COMMIT_HASH
        echo $BUILD_DATE > ./server/dist/BUILD_DATE
        echo $BUILD_VERSION > ./server/dist/TAG_NAME

        # Generate the dependency licenses files (one for the UI and one for the webserver),
        # concatenate them to one file under ./src/server
        ./scripts/yarn-licenses.sh

        # Create a server directory in root and copy the server directory into it
        cp -r server ${CRAFT_PART_INSTALL}/
        cd ${CRAFT_PART_INSTALL}/server/
        npm ci
        npm run build

  install-node:
    plugin: nil
    override-build: |
      curl -s "https://nodejs.org/dist/v14.21.3/node-v14.21.3-linux-x64.tar.gz" | tar --strip-components=1 -xzf - -C "${CRAFT_PART_INSTALL}"
  
  non-root-user:
    plugin: nil
    overlay-script: |
        # Create a user in the $CRAFT_OVERLAY chroot
        groupadd -R $CRAFT_OVERLAY -g 1001 ubuntu
        useradd -R $CRAFT_OVERLAY -M -r -u 1001 -g ubuntu ubuntu
    override-prime: |
        craftctl default
